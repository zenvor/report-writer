#!/bin/bash
# ReportWriter å¯åŠ¨è„šæœ¬
set -euo pipefail

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
cd "$SCRIPT_DIR"

# æ£€æŸ¥å¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼›å¦‚ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºå¹¶å®‰è£…ä¾èµ–
if [ -f "venv/bin/activate" ]; then
    source venv/bin/activate
elif [ -f "venv/Scripts/activate" ]; then
    source venv/Scripts/activate
else
    echo "ğŸ”§ æœªæ‰¾åˆ°è™šæ‹Ÿç¯å¢ƒï¼Œæ­£åœ¨è‡ªåŠ¨åˆ›å»º venv å¹¶å®‰è£…ä¾èµ–..."
    # é€‰æ‹©å¯ç”¨çš„ Python è§£é‡Šå™¨
    python_bin="python3"
    if ! command -v "$python_bin" >/dev/null 2>&1; then
        if command -v python >/dev/null 2>&1; then
            python_bin="python"
        else
            echo "âŒ æœªæ‰¾åˆ° Pythonï¼Œè¯·å…ˆå®‰è£… Python3 åé‡è¯•"
            exit 1
        fi
    fi
    "$python_bin" -m venv venv
    # æ¿€æ´»å¹¶å®‰è£…ä¾èµ–
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
    else
        # å…¼å®¹éƒ¨åˆ†ç¯å¢ƒ
        source venv/Scripts/activate || true
    fi
    if [ -f "requirements.txt" ]; then
        echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–..."
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
    else
        echo "âš ï¸  æœªæ‰¾åˆ° requirements.txtï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
    fi
fi

# è¿è¡Œä¸»ç¨‹åº
python src/report_writer.py "$@"